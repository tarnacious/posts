

function fire() {

	var palette = [[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[1,1,3],[0,0,2],[0,0,4],[1,2,7],[1,4,13],[3,7,19],[3,6,25],[3,8,30],[4,9,39],[6,10,45],[6,11,53],[8,12,59],[8,14,62],[9,16,68],[11,17,77],[10,18,81],[11,20,87],[13,21,93],[15,24,101],[16,24,105],[15,26,108],[16,26,111],[14,25,107],[12,23,103],[13,21,96],[11,20,89],[13,18,82],[11,17,75],[10,15,70],[8,14,62],[8,12,57],[7,12,50],[6,10,47],[4,9,39],[6,7,35],[4,7,26],[5,4,20],[4,4,14],[2,1,7],[1,1,3],[0,0,2],[0,0,0],[0,0,0],[1,1,1],[0,0,2],[0,0,2],[0,1,0],[0,1,0],[5,0,0],[11,0,0],[19,0,2],[25,1,1],[32,0,3],[36,0,0],[39,0,0],[44,0,0],[49,1,1],[53,2,1],[60,0,0],[63,0,0],[68,0,1],[71,0,0],[76,0,0],[81,1,0],[87,1,0],[91,1,1],[98,0,1],[102,0,0],[108,0,2],[113,1,0],[116,0,1],[121,1,0],[125,1,1],[131,1,0],[135,0,0],[141,0,0],[147,0,0],[152,0,0],[154,0,0],[159,1,0],[165,1,0],[169,1,0],[175,0,1],[180,0,1],[186,0,1],[190,0,0],[193,1,0],[196,1,0],[203,1,0],[207,2,0],[213,0,0],[218,0,0],[224,0,0],[228,0,0],[234,0,0],[238,0,0],[241,1,0],[246,2,2],[248,3,2],[251,1,2],[253,0,2],[254,0,2],[253,0,0],[254,0,0],[254,0,0],[253,1,0],[253,1,0],[251,2,0],[252,5,0],[252,8,0],[254,12,1],[254,14,1],[254,17,1],[254,19,0],[255,20,1],[254,24,0],[255,26,2],[255,30,0],[255,33,2],[254,36,0],[254,38,0],[253,42,0],[254,43,0],[254,46,0],[254,48,0],[254,50,0],[254,55,0],[254,58,0],[254,60,0],[255,63,0],[255,64,1],[255,68,0],[255,71,1],[255,75,0],[254,77,1],[253,81,0],[255,83,0],[254,86,0],[255,87,0],[255,90,0],[255,93,0],[255,95,0],[253,99,1],[254,102,1],[254,105,2],[254,107,1],[255,108,2],[254,112,0],[255,115,2],[254,119,1],[255,122,1],[253,125,0],[255,127,0],[253,131,0],[254,132,0],[255,135,0],[255,138,0],[255,141,0],[254,143,0],[255,147,0],[255,149,1],[255,152,1],[255,153,2],[255,156,0],[255,159,2],[255,163,0],[255,166,2],[252,167,0],[254,169,0],[254,174,1],[255,177,2],[255,178,2],[255,180,1],[255,184,2],[253,188,0],[254,191,0],[254,194,0],[254,196,1],[255,197,1],[254,201,1],[255,204,1],[254,208,0],[255,209,1],[254,213,0],[255,216,1],[253,219,0],[254,220,0],[255,223,0],[255,226,0],[255,229,0],[254,232,0],[255,235,0],[255,238,0],[255,240,1],[255,241,0],[254,244,0],[255,246,1]];

	var font = [[0, 30, 48, 62, 55, 62, 0], [3, 3, 31, 51, 51, 31, 0], [0, 30, 3, 3, 3, 30, 0], [48, 48, 62, 51, 51, 62, 0], [0, 30, 51, 63, 3, 30, 0], [56, 12, 62, 12, 12, 12, 0], [0, 62, 51, 51, 62, 48, 31], [3, 3, 31, 51, 51, 51, 0], [12, 0, 14, 12, 12, 30, 0], [48, 0, 48, 48, 48, 48, 30], [3, 3, 27, 15, 27, 51, 0], [14, 12, 12, 12, 12, 30, 0], [0, 51, 127, 127, 107, 99, 0], [0, 31, 51, 51, 51, 51, 0], [0, 30, 51, 51, 51, 30, 0], [0, 31, 51, 51, 31, 3, 3], [0, 62, 51, 51, 62, 48, 48], [0, 31, 51, 3, 3, 3, 0], [0, 62, 3, 30, 48, 31, 0], [12, 63, 12, 12, 12, 56, 0], [0, 51, 51, 51, 51, 62, 0], [0, 51, 51, 51, 30, 12, 0], [0, 99, 107, 127, 62, 54, 0], [0, 51, 30, 12, 30, 51, 0], [0, 51, 51, 51, 62, 24, 15]];

	var width = 100;
	var height = 50;
	var tileSize = 8;
	var messages = messageTimer(["old school","for fun","",""]);

	function messageTimer(messages) {
		var frameCount = 0;
		var messageIndex = 0;

		return function(action) {
			if (messageIndex == messages.length) messageIndex = 0;

			if (frameCount == 30) {
				frameCount = 0;
				messageIndex++;
			};

			if (frameCount > 15) action(messages[messageIndex]);
			frameCount++;
		}
	}

	function loop(data) {
		data = fuel(data);
		data = calculate(data);
		messages(function(message) { update = write(data, message); });
		draw(data);
		setTimeout(function() { loop(data) },1);
	}

	function write(data, message) {
		var ox =  (width / 2) - (message.length * 4);
		var oy = 20;

		for(c = 0; c < message.length; c++)
		for(y = 0; y < 7; y ++) {
			var charCode = message.charCodeAt(c) - 97;
			if (charCode < 0 || charCode > 25) break;
			for(x = 0; x < 7; x ++) {
				if ( (font[charCode][y] & Math.pow(2,x))  > 0 ) {
					data[ (ox + (8 * c) + x) + ( (oy + y) * width )] = 200;
				}
			}
		}
		return data;
	}

	function fuel(data) {
		for(i = (width -2) * (height); i < (width * height); i++) {
			data[i] =Math.random() * 550 + 50;
		}
		return data;
	}

	function calculate(current) {
		var offsets = [0,width,width+1,width-1,width * 2];
		var update = [];
		for(i = 0; i < width * height; i++) {
			var sum = 0;
			for(oi = 0; oi < offsets.length; oi++) {
				value = current[i + offsets[oi]];
				if (isNaN(value)) value = 0;
				sum += value;
			};
			update[i] = sum / (offsets.length + 0.5);

		};
		return update;
	}

	function draw(data) {
		var canvas = document.getElementById('fire');
		if (canvas.getContext) {
			ctx = canvas.getContext('2d');
			for(y = 0; y < height-2; y++)
			for(x = 0; x < width; x++) {
				var index = Math.round(data[x + (y * width)]);
				if (index >= palette.length) index = palette.length - 1;
				var c = palette[index];
				ctx.fillStyle = "rgb(" + c[0] + "," + c[1] + "," + c[2] + ")";
				ctx.fillRect((x*tileSize),(y*tileSize),(x*tileSize*2),(y*tileSize *2));
			};
		};
	}

	loop([]);
}

$(function() { fire(); });
